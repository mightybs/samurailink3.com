---
layout: post
title: "Server-Bits #8: TrueCrypted Home Directories or SHROUD"
date: 2010-05-04T12:56:00-04:00
categories:
 - Server
 - Linux
 - Server-Bits
---

<div class='post'>
So, I've completed work (a while ago... was still gathering the time necessary to write this blog post) on <strike>Project: SHROUD</strike>&nbsp;(Link defunct for now...)&nbsp;and it is time to release the documentation on how I've put it together. The pieces have been floating around the internet for some time, but I'm here to put this in one central location so you can have it up and running in no time flat.<br /><br />But what exactly is Project SHROUD?<br /><i>From the PastaNet blog:</i> "Completely encrypted storage space via PastaNet using TrueCrypt and SSH. Hosted on an encrypted RAID-5 server and stored in your own personal encrypted volume, your data is not only safe, but extremely secured. Your personal file volume is dismounted 60 seconds after you disconnect, leaving your data completely encrypted (Twice over!!). Completely secured network access through SSH encryption. You can access your SHROUD drive through any FTP program that supports SFTP (The vast majority of these programs do) or by mounting it as a network drive through ExpanDrive (working on alternatives for this) [Linux users need not apply, as mounting SSH volumes is built into the OS]. Completely encrypted, completely secured, cloud-based storage."<br /><br />See the full article after the jump.<br /><br /><a name='more'></a><br />When a user logs in, their TrueCrypt volume is mounted as their home directory. The system then watches to see when the user logs off and dismounts their TrueCrypt volume 60 seconds after they disconnect. This SFTP storage area can then be used through virtually any FTP program or mounted as a Network Shared Drive for the user. These users are forbidden from shell access, VPN, and other areas of the filesystem.<br />As a server admin, it is bad karma (and very bad practice) to keep your users' passwords. Create the volume, throw away the key, the rest is up to them. This keeps them <i>and</i> you safe in a worst-case-scenario. <br /><br />The first thing you need to do is create a directory in /home for the location of the TrueCrypt volumes.<br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;">mkdir /home/private</blockquote>In this directory, we will keep all of the SHROUD users' TrueCrypt volumes. They will have a home directory to be used purely as a mount point for the volume.<br /><br />Now, the difficult part (Which isn't too terribly hard), compiling a more modern version of PAM, known to work well with automatic TrueCrypt mounting <b>(Terminal Commands Ahoy!)</b>:<br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">wget http://dl.dropbox.com/u/860936/Blog/pam_1.1.1.orig.tar.gz<br />tar xfzv pam_1.1.1.orig.tar.gz<br />cd Linux-PAM-1.1.1/<br />./configure<br />cd modules/pam_exec/<br />make<br />sudo cp .libs/pam_exec.so /lib/security/pam_exec_UNSTABLE.so</span> </blockquote>We have just compiled the new PAM_EXEC to a new, different file on your system. We will reference this module in the TrueCrypt-mounting script instead of your standard PAM module. This will avoid dependency and package confliction issues later on. We now need to edit the "Common-Auth" and "Common-Session" text files that controls what happens when a user enters their password. We'll add the lines via the 'echo' command with sudo privileges.<br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">sudo echo "# SHROUD code below" &gt;&gt; /etc/pam.d/common-auth<br /><br />sudo echo "auth optional pam_exec_UNSTABLE.so debug expose_authtok seteuid /bin/bash /bin/cryptmount.sh" &gt;&gt; /etc/pam.d/common-auth<br /><br />sudo echo "# SHROUD code below" &gt;&gt; /etc/pam.d/common-session<br /><br />sudo echo "session optional pam_exec_UNSTABLE.so seteuid /bin/bash /bin/cryptmount.sh" &gt;&gt; /etc/pam.d/common-session</span></blockquote>&nbsp;Whenever a user now logs in, the shell will automatically execute "cryptmount.sh". One problem: cryptmount.sh doesn't exist yet. You need to create it. Create a new file inside of '/bin' and name it "cryptmount.sh". Here are the contents of that file:<br /><i>[TIP: For your convenience, <a href="https://docs.google.com/leaf?id=0B1Rrmx2rA2GKYjZlNTNlZDAtMmE1Ni00NmNjLWEzZDQtNTg0ODEyOTJlZjdk&amp;hl=en">here is the file</a>]</i><br /><br /><blockquote><span style="font-size: x-small;"><span style="font-family: 'Courier New', Courier, monospace;">#!/bin/bash</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;"># /bin/cryptmount.sh</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">CRYPTVOLUME=/home/private/$PAM_USER.tc</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">MOUNTPOINT=/home/$PAM_USER</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">case "$PAM_USER" in</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; <b>root | anotheruser) #homedirs of non-shroud_users are not encrypted</b></span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp; exit 0</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; ;;</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">esac</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">case "$PAM_TYPE" in</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth )</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; head -c -1 | truecrypt -t&nbsp; --protect-hidden=no -k "" \</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "$CRYPTVOLUME" "$MOUNTPOINT"</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; close_session )</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MOUNTS=$(mount | grep " $MOUNTPOINT ")</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if test -z $MOUNTS ; then</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo MOUNTS&nbsp; $MOUNTS &gt; /tmp/debug</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit 0</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OTHER=$(who | grep "^$PAM_USER " | grep -v " $PAM_TTY ")</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if test -z "$OTHER"; then</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo truecrypt -d $MOUNTPOINT | at now + 1 minute</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">esac</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: 'Courier New', Courier, monospace;">exit 0</span></span></blockquote>You will need to make sure to add your username, and any other username that <i><b>will not</b></i> be using SHROUD to that list of usernames inside of the script. Users will see an error if they are not using SHROUD, but are not listed. Here are the rules: <b>Using SHROUD - Not named in the file. Not using SHROUD - Named in the file.</b><br />Get it? Good.<br /><br />The next thing we need to do is limit the amount of access your SHROUD users have. We want them to be 'jailed' into their home directory, with no hope of escaping. We need to edit the SSHD configuration file to do this.<br /><blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">sudo nano /etc/ssh/sshd_config</span></blockquote>Comment out the line "Subsystem sftp /usr/lib/openssh/sftp-server" by placing a '#' next to it. It'll end up looking like this:<br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#Subsystem sftp /usr/lib/openssh/sftp-server</span></blockquote>Now that we have the old system commented out, you will need to add the following lines of code to your sshd_config:<br /><i>[TIP: Use Control+O to save the file and Control+X to exit nano]</i><br /><blockquote><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#Start SHROUD code here</span><br /><span style="font-size: x-small;">Subsystem sftp internal-sftp</span><br /><span style="font-size: x-small;"><br /></span><br /><span style="font-size: x-small;">UsePAM yes</span><br /><span style="font-size: x-small;"><br /></span><br /><span style="font-size: x-small;">Match group shroud_users</span></div><blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">ChrootDirectory /home/%u</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">X11Forwarding no</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">AllowTcpForwarding no</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">ForceCommand internal-sftp</span></blockquote></blockquote><blockquote><br /></blockquote>We will be putting all of the SHROUD users into a group named "shroud_users" and they will be forced to the following rules:<br /><ul><li>They will be forced into their home directory, they will not have full filesystem access.</li><li>They will not be able to forward graphical (X11) applications.</li><li>They will not be able to forward TCP (They do not have VPN access)</li><li>When they log on, the command '<span style="font-family: 'Courier New', Courier, monospace;">internal-sftp</span>' is used instead of a standard shell. This prevents them from having shell access to the server.</li></ul>You can also give granular permissions to specific users. Lets say that you want <b>bob</b> to have SHROUD, but would also like to give him the ability to use VPN:<br /><blockquote style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">Match user <b>bob</b></span></blockquote><blockquote><blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">ChrootDirectory /home/%u</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">X11Forwarding no</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">AllowTcpForwarding <b>yes</b></span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">ForceCommand internal-sftp</span></blockquote></blockquote>You can set specific user permissions this way. You can even remove the 'chroot' bit if you wanted to give a user permission to roam about your filesystem, taking whatever they have access to (this is helpful if you are running a distribution center).<br /><br />The next step is to make a script to make building the users and setting the permissions correctly stupidly easy for you to do. In my experience, creating a SHROUD user with 1GB of usable space took about 10-12 minutes, depending on how much I fat-fingered the commands. With this script, you'll be creating users in 1-2 minutes:<br /><i>[TIP: READ THE COMMENTS!! Commented code (any line starting with a '#') is an easy way to figure out exactly what is going on. Use this script as a learning experience!]</i><br /><blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#!/bin/bash</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    This program is free software: you can redistribute it and/or modify</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    it under the terms of the GNU General Public License as published by</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    the Free Software Foundation, either version 3 of the License, or</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    (at your option) any later version.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    This program is distributed in the hope that it will be useful,</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    GNU General Public License for more details.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    You should have received a copy of the GNU General Public License</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    along with this program.  If not, see http://www.gnu.org/licenses/gpl.html.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">#    Original code by SamuraiLink3 (2010)</span><br /><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">MakeUser() {</span><br /><blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #The commands below will set the variable names for both the user and the user's password. These will then be used to create the new user, volume, directory structure, and set them all in motion.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo -n "Enter username for new SHROUD user: "</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    read user</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo ""</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo -n "Now enter the password for the new user: "</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    read password</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    VolumeCreateAndMove</span></blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">}</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">VolumeCreateAndMove() {</span><br /><blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo "We need sudo permission to continue..."</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo echo ""</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    cat /dev/urandom | head -c 4096 &gt; rand.txt</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #This command has created a random 4096-byte text file from /dev/urandom for random salt used to create the TrueCrypt volume</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    truecrypt --text -c $user -p $password --encryption=AES --filesystem=none --hash=ripemd-160 --size=1073741824 --random-source=rand.txt -v --non-interactive --volume-type=normal --keyfiles=</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #This command creates a TrueCrypt volume with the name of the user and the password you chose at the start of the script. The size is 1GB in bytes. It is using AES and RIPEMD-160 to create a normal TrueCrypt volume.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo truecrypt --text --filesystem=none --password=$password --keyfiles= --protect-hidden=no $user</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo truecrypt --text -l</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #This will mount the new user volume and list the TrueCrypt volumes for the next step.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo -n "Please choose the mapper number you would like to format: "</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    read number</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sleep 5</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo mkfs.ext4 /dev/mapper/truecrypt$number</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #After the volume is mounted, the admin will need to choose which TrueCrypt mount to format (DO NOT FORMAT THE WRONG ONE!!). After this, an EXT4 filesystem is created within the volume.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo mkdir /home/$user</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo truecrypt -d $user</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo truecrypt --text --password=$password --keyfiles= --protect-hidden=no $user /home/$user</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sleep 3</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo cp -r /etc/ServerSoftware/SHROUD/* /home/$user/</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #This is the directory you will need to populate with your wanted default folder structure, change this at your will.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    UserAddAndConfigure</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #Now, the TrueCrypt volume is mounted as the user's home directory and a folder structure is copied into the new volume. You will need to create this folder structure on your own server. Mine is as follows: Code Documents Downloads Misc Music Pictures Videos. Create any directories/files you would like to be pushed and defaulted to all of your users.</span></blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">}</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">UserAddAndConfigure() {</span><br /><blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo useradd -N -M -g shroud_users -s /bin/sh -b /home/$user -p $password $user    </span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #The user is created with the 'shroud_users' group, will not create a home directory, and will not create a specific user-group (as we are placing them into the 'shroud_users' group).</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo chown -R $user /home/$user/</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #This makes the user the owner of all the folders within their home directory</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo chmod -R 700 /home/$user/</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #This sets secure permissions on the folders of the user</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo chown root /home/$user/</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo chgrp shroud_users /home/$user/</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo chmod 750 /home/$user/</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #For chroot to work correctly, the chrooted directory needs to be owned by root and not writable by any other party. To satisfy these requirements, we make the owner of the main folder, root, but we make the folders inside of the home directory, owned and writable by the user. This is why the top level directory is not writable in SHROUD, but everything inside of it is. A slight workaround, but it works for now and maintains security.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo truecrypt --text -d $user</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #This dismounts the user's directory</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo $user:$password | sudo chpasswd</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #This command 'chpasswd' works differently from 'passwd', it is a scripted way to change a user's password. While it is normally used to change a very large list of users, it works nicely for our script as well.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    sudo mv $user /home/private/$user.tc</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #This will move the user's TrueCrypt volume to the /home/private directory so cryptmount.sh can get to it.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    Cleanup</span></blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">}</span><br /><blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">Cleanup() {</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo "User: "$user" created."</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    rm rand.txt</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #Nicely removes the random-salt text file.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo "Cleanup complete."</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo "========================"</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo "USER DETAILS:"</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo "USERNAME: "$user</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo "PASSWORD: "$password</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo "========================"</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    #Echo's the username and password so the user can writedown/memorize/backup their username and password.</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    echo "Program complete, now exiting."</span></blockquote><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">    }</span><br /><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">MakeUser</span></blockquote>To make it easier on you (Because copy/paste can be fickle with some text editors/IDEs) <a href="https://docs.google.com/leaf?id=0B1Rrmx2rA2GKZjk1ZDg5ZDctNzQ5Yy00YWNiLWEyODYtMzliZTc5MGY4Y2Rh&amp;hl=en">here is the file</a>, I recommend reading the file with <a href="http://notepad-plus.sourceforge.net/uk/site.htm">Notepad++</a> on Windows or <a href="http://projects.gnome.org/gedit/">Gedit</a> on Linux.<br /><br />Now all that is left is to create your first user, distribute a connection program (such as <a href="http://portableapps.com/apps/internet/filezilla_portable">FileZilla Portable</a>), and start providing encrypted storage. So far, this has been the biggest undertaking on PastaNet and the biggest post on this blog. Enjoy it.<br /><br />To make things easier on my users, I have rolled a modified <a href="http://portableapps.com/apps/internet/filezilla_portable">FileZilla Portable</a> zip file for them to download and easily connect to my server. The modifications were trivial, I just saved the standard connection profile to the 'saved sites' button in FileZilla, then re-zipped the folder. I provide this file to each user that will be using the SHROUD system. I suggest doing the same for your users. <a href="https://docs.google.com/fileview?id=0B1Rrmx2rA2GKOTQ0ODViYzEtYjI4MS00NGZmLTgxNDItYTg0MDIxYWIyYjk4&amp;hl=en">Here is the documentation I provide for my users</a>, I also suggest that you build some form of documentation that your users can dig through as well.<br /><br />There are a few things I would like to be made known, there are a few quirks with Project SHROUD that you <i>(and your users) </i>should be aware of:<br /><ul><li> The user cannot add/remove files/directories to the top-level (or ‘root’) directory. You should create a folder structure that your users can utilize to organize their files.</li><li>Due to the very nature of SFTP, it is impossible to determine the amount of free space you have left on your SHROUD drive. The easiest way to tell is to check the amount of space your files are currently taking up, then subtract the amount of known space you have been allotted. This is quite the annoying bug, but is inherent to SFTP itself, not much can be done to fix it without going to the protocol level.</li><li>If a user's machine is compromised by keyloggers/spyware/viruses, the user's password could be exposed, rendering the encrypted data and user account vulnerable.</li><li>By the same token, if a user's machine is stolen/remote-controlled while the drive is mounted, the data the attacker could be after is already decrypted.</li><li>Saving your password is not recommended, especially if your system is unencrypted.</li><li>If a user loses/forgets/erases their password: <b>There is no backdoor.</b> TrueCrypt does not provide any hidden routes or safety nets. The user's data is stored using state-of-the-art encryption, if the password is gone, the data is gone. Its as simple as that. </li></ul><br /><b>This post heavily influenced, paraphrased, and copied (with very slight modification) from the following sources:</b><br /><b><br /><a href="http://blog.littleimpact.de/index.php/2009/09/14/automatic-encryption-of-home-directories-using-truecrypt-62-and-pam_exec/">Little Impact - Automatic encryption of home directories using TrueCrypt 6.2a and pam_exec</a></b><br /><b><a href="http://www.debian-administration.org/articles/590">Debian-Administration - OpenSSH SFTP chroot() with ChrootDirectory</a></b><br /><b><a href="http://undeadly.org/cgi?action=article&amp;sid=20080220110039">OpenBSD journal @ undeadly.org - Chroot in OpenSSH</a> - Contributed by <a href="http://erdelynet.com/">merdely (Mike Erdely)</a></b><br /><b><a href="http://ubuntuforums.org/showthread.php?p=9014786#post9014786">This UbuntuForums.org post</a> and the UbuntuForums community in general, this community is one of the best I have ever been involved with and they make me a smarter person every time I log on. I want to specifically thank <a href="http://ubuntuforums.org/member.php?u=204457">cdenley</a> and <a href="http://ubuntuforums.org/member.php?u=329678">sublimination</a> for all the help they provided me with on this project.</b><br /><br /><b>These people have done the amazing legwork. Go to their blog, leave comments, click ads, donate cash, do something if this post helped you out at all. Without them, Project: SHROUD would just be a twinkle in my eye. Props to them!!</b><br /><br /><i>About Server-Bits:</i><br /><br />If you've ever wanted to get started building a server, right in your own backyard, kitchen, closet, mother's closet, mother's basement, then this is the read for you. Aimed at the not-so-technical-but-willing-to-learn, this will give you everything you need to build... that monster-server you've dreamed of. <b>My goal: To  give you a working, rocking server, for free, that you can use daily.</b></div>
